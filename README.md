# AI-Enabled Survey Service Backend

A Flask-based backend API for managing AI-powered survey interactions between companies and customers.

## ğŸš€ Features

- **Company Management**: Register and manage companies
- **Survey Creation**: Create and manage surveys under companies
- **AI-Powered Chat**: Real-time AI-driven survey interactions with session management
- **Schema-Based Data Collection**: AI automatically fills 11 predefined business intelligence schemas
- **Progress Tracking**: Monitor survey completion with metadata array (completed schemas)
- **Customer Management**: Track survey respondents and their responses
- **Complete Chat History**: Store and retrieve all survey conversations
- **Session Persistence**: Each customer has a persistent AI session throughout the survey
- **Supabase Integration**: PostgreSQL database with automatic relationships
- **CORS Enabled**: Ready for React frontend integration
- **RESTful API**: Clean, well-documented API endpoints

## ğŸ¤– AI Integration

This backend seamlessly integrates with an AI microservice to conduct intelligent, conversational surveys:

- **Automatic Session Management**: Each customer gets a unique AI session on registration
- **Smart Data Collection**: AI asks questions and automatically structures responses into schemas
- **11 Business Intelligence Schemas**: Covers workflows, pain points, budgets, security, and more
- **Status Tracking**: Know when each schema is completed (status flag)
- **Metadata Storage**: All completed schemas stored in customer's JSONB metadata field

**ğŸ“š Read more:**
- [AI Integration Flow](AI_INTEGRATION_FLOW.md) - Complete technical documentation
- [Testing Guide](TESTING_GUIDE.md) - Step-by-step testing instructions
- [Integration Summary](AI_INTEGRATION_SUMMARY.md) - Quick overview of changes

## ğŸ“‹ Prerequisites

- Python 3.8+
- Supabase account (free tier works)
- AI Microservice running on ports 5000 and 5001 (required for full functionality)
- `jq` command-line tool (optional, for running test script)

## ğŸ› ï¸ Installation

### 1. Clone or navigate to the project

```bash
cd /Users/akashsingh/Downloads/TF
```

### 2. Create virtual environment

```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

### 3. Install dependencies

```bash
pip install -r requirements.txt
```

### 4. Set up Supabase

1. Create a free account at [supabase.com](https://supabase.com)
2. Create a new project
3. Go to SQL Editor and execute the contents of `schema.sql`
4. Get your project URL and anon key from Settings > API

**For existing databases:** If you're upgrading an existing installation, run the migration:
```bash
# In Supabase SQL Editor, run:
migrations/add_session_and_metadata.sql
```

### 5. Configure environment

```bash
cp .env.example .env
```

Edit `.env` and add your credentials:

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-supabase-anon-key
AI_MICROSERVICE_URL=http://localhost:5001/api/chat
FLASK_PORT=5000
CORS_ORIGINS=http://localhost:3000
```

## ğŸƒ Running the Application

### Using Python directly

```bash
python app.py
```

### Using the bash script [[memory:7539227]]

```bash
chmod +x run.sh
./run.sh
```

The API will be available at `http://localhost:5000`

## ğŸ§ª Quick Integration Test

Test the complete AI integration flow with the automated test script:

```bash
chmod +x test_ai_integration.sh
./test_ai_integration.sh
```

This script will:
1. âœ… Create a test company and survey
2. âœ… Register a customer (starts AI session)
3. âœ… Send a chat message
4. âœ… Check metadata for completed schemas
5. âœ… Retrieve chat history

**Requirements:** `jq` command-line tool for JSON parsing

## ğŸ“š API Documentation

Comprehensive API documentation is available in [`API_DOCUMENTATION.md`](API_DOCUMENTATION.md).

### Quick Start Example

**Note:** All UUIDs are generated by the React frontend and sent to the backend.

```bash
# 1. Create a company (React generates UUID)
curl -X POST http://localhost:5000/api/companies \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "123e4567-e89b-12d3-a456-426614174000",
    "name": "TechCorp",
    "sector": "Technology",
    "products": "SaaS Solutions"
  }'

# 2. Create a survey (React generates UUID)
curl -X POST http://localhost:5000/api/companies/123e4567-e89b-12d3-a456-426614174000/surveys \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "987fcdeb-51a2-43d7-9876-543210fedcba",
    "title": "Customer Satisfaction Survey",
    "description": "Help us improve"
  }'

# 3. Register a customer (React generates UUID)
curl -X POST http://localhost:5000/api/surveys/987fcdeb-51a2-43d7-9876-543210fedcba/customers \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "456e7890-a12b-34c5-d678-901234567890",
    "name": "John Doe",
    "age": 28,
    "gender": "Male"
  }'

# 4. Send a chat message
curl -X POST http://localhost:5000/api/surveys/987fcdeb-51a2-43d7-9876-543210fedcba/customers/456e7890-a12b-34c5-d678-901234567890/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "I love your product!"
  }'
```

## ğŸ—ï¸ Project Structure

```
TF/
â”œâ”€â”€ app.py                  # Main Flask application
â”œâ”€â”€ config.py               # Configuration management
â”œâ”€â”€ database.py             # Supabase client wrapper
â”œâ”€â”€ utils.py                # Helper functions
â”œâ”€â”€ requirements.txt        # Python dependencies
â”œâ”€â”€ schema.sql             # Database schema
â”œâ”€â”€ .env.example           # Environment template
â”œâ”€â”€ .gitignore            # Git ignore rules
â”œâ”€â”€ run.sh                # Startup script
â”œâ”€â”€ README.md             # This file
â”œâ”€â”€ API_DOCUMENTATION.md  # Complete API docs
â””â”€â”€ routes/
    â”œâ”€â”€ companies.py      # Company endpoints
    â”œâ”€â”€ surveys.py        # Survey endpoints
    â””â”€â”€ customers.py      # Customer & chat endpoints
```

## ğŸ”‘ Key Endpoints

### Companies
- `POST /api/companies` - Create company
- `GET /api/companies/{uuid}` - Get company
- `PUT /api/companies/{uuid}` - Update company
- `DELETE /api/companies/{uuid}` - Delete company

### Surveys
- `POST /api/companies/{uuid}/surveys` - Create survey
- `GET /api/companies/{uuid}/surveys` - List company surveys
- `GET /api/surveys/{uuid}` - Get survey details
- `GET /api/surveys/{uuid}/stats` - Get survey statistics

### Customers & Chat
- `POST /api/surveys/{uuid}/customers` - Register customer
- `POST /api/surveys/{uuid}/customers/{uuid}/chat` - Send message & get AI response
- `GET /api/surveys/{uuid}/customers/{uuid}/history` - Get chat history

## ğŸ¤– AI Microservice Integration

The backend expects an AI microservice at the URL specified in `AI_MICROSERVICE_URL`.

### Expected Request Format:
```json
{
  "messages": [
    {"role": "user", "content": "Hello"},
    {"role": "assistant", "content": "Hi there!"}
  ],
  "context": {
    "survey_title": "...",
    "company_name": "...",
    "customer_name": "..."
  }
}
```

### Expected Response Format:
```json
{
  "response": "AI generated response text"
}
```

## ğŸ—„ï¸ Database Schema

The system uses 4 main tables:

1. **companies** - Store company information
2. **surveys** - Surveys created by companies
3. **customers** - Survey respondents
4. **chat_messages** - Chat history (user & AI messages)

All tables use UUIDs as primary keys. Cascading deletes ensure data integrity.

See `schema.sql` for complete schema details.

## ğŸ”§ Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `SUPABASE_URL` | Supabase project URL | Required |
| `SUPABASE_KEY` | Supabase anon key | Required |
| `AI_MICROSERVICE_URL` | AI service endpoint | `http://localhost:5001/api/chat` |
| `FLASK_PORT` | Port to run Flask on | `5000` |
| `FLASK_ENV` | Environment (development/production) | `development` |
| `CORS_ORIGINS` | Allowed CORS origins (comma-separated) | `http://localhost:3000` |

## ğŸ§ª Testing

### Health Check
```bash
curl http://localhost:5000/health
```

### Using Postman/Thunder Client
Import the endpoints from `API_DOCUMENTATION.md` into your API testing tool.

## ğŸš¨ Error Handling

All endpoints return consistent error responses:

```json
{
  "success": false,
  "error": "Error description",
  "error_type": "validation_error"
}
```

Error types:
- `validation_error` (400)
- `not_found` (404)
- `database_error` (500)
- `ai_service_error` (503)
- `server_error` (500)

## ğŸ”’ Security Notes

**Current State:**
- All endpoints are public (no authentication)
- CORS enabled for configured origins
- SQL injection protected by Supabase client
- UUID validation on all endpoints

**Recommended for Production:**
- Add JWT authentication
- Implement rate limiting
- Add API keys for companies
- Enable Supabase Row Level Security (RLS)
- Use HTTPS in production
- Add input sanitization
- Implement logging and monitoring

## ğŸ“Š Response Format

### Success Response:
```json
{
  "success": true,
  "data": { ... },
  "message": "Optional message"
}
```

### Error Response:
```json
{
  "success": false,
  "error": "Error message",
  "error_type": "error_category"
}
```

## ğŸ¤ Integration with React Frontend

1. Update `CORS_ORIGINS` in `.env` with your React app URL
2. Use the API endpoints documented in `API_DOCUMENTATION.md`
3. Always check `response.success` before accessing `response.data`
4. Handle error responses appropriately

Example React usage:
```javascript
import { v4 as uuidv4 } from 'uuid';

// Generate UUID in React
const companyUuid = uuidv4();

const response = await fetch('http://localhost:5000/api/companies', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    uuid: companyUuid,  // UUID generated by React
    name: 'My Company',
    sector: 'Tech'
  })
});

const data = await response.json();
if (data.success) {
  console.log('Company created:', data.data);
  // Store companyUuid for future use
} else {
  console.error('Error:', data.error);
}
```

## ğŸ“ Development

### Adding New Endpoints

1. Create or modify blueprint in `routes/`
2. Use `@handle_errors` decorator for consistent error handling
3. Use `success_response()` and `error_response()` helpers
4. Update `API_DOCUMENTATION.md`

### Database Changes

1. Modify `schema.sql`
2. Apply changes in Supabase SQL Editor
3. Update relevant route handlers

## ğŸ› Troubleshooting

### "SUPABASE_URL is required"
- Ensure `.env` file exists and contains valid Supabase credentials

### "Failed to connect to AI microservice"
- Check if AI microservice is running
- Verify `AI_MICROSERVICE_URL` in `.env`
- Check firewall/network settings

### CORS errors in browser
- Add your frontend URL to `CORS_ORIGINS` in `.env`
- Restart Flask server after changes

### Database errors
- Verify Supabase connection
- Check if tables are created (run `schema.sql`)
- Check Supabase dashboard for errors

## ğŸ“¦ Deployment

### Using Gunicorn (Production)

```bash
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### Environment Setup

1. Set `FLASK_ENV=production`
2. Use strong database credentials
3. Enable HTTPS
4. Configure proper CORS origins
5. Set up monitoring and logging

## ğŸ“„ License

This project is provided as-is for your use.

## ğŸ™‹ Support

For questions or issues:
1. Check `API_DOCUMENTATION.md` for endpoint details
2. Review error responses for debugging info
3. Verify environment configuration
4. Check Supabase logs for database issues

---

**Built with Flask, Supabase, and â¤ï¸**

